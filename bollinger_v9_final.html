<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bollinger VIX10 â€” Deriv (V9 Final)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
Â  :root{
Â  Â  --bg:#0b0f16; --panel:#0f1722; --muted:#98a0b3; --accent:#6cc3d5; --green:#9bd08a; --red:#ef6b73; --yellow:#ffd780;
Â  Â  font-family: Inter, Arial, sans-serif;
Â  }
Â  body{background:linear-gradient(180deg,#080a0f 0%, #0b0f16 100%); color:#e6eef6; margin:0; padding:18px;}
Â  .wrap{max-width:1150px;margin:0 auto;}
Â  .card{background:var(--panel); border-radius:10px; padding:14px; box-shadow:0 8px 30px rgba(0,0,0,0.6);}
Â  header{display:flex; gap:12px; align-items:center; margin-bottom:12px;}
Â  header h1{margin:0;color:var(--accent); font-size:18px;}
Â  .grid{display:grid; grid-template-columns:360px 1fr; gap:16px;}
Â  label{display:block;color:var(--muted);font-size:13px;margin-top:10px}
Â  input,select,button{width:100%; padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04); background:#08101a;color:#e6eef6}
Â  button{cursor:pointer;font-weight:700}
Â  .row{display:flex; gap:8px}
Â  .btn-green{background:#188a56}
Â  .btn-red{background:#bf2e31}
Â  .btn-yellow{background:#ffaa00}
Â  #status{margin-top:12px;font-weight:700}
Â  #log{height:100px; overflow:auto; background:#08101a; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.02); color:var(--muted)}
Â  #result-log{height:100px; overflow:auto; background:#08101a; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.02); color:var(--muted)}
Â  #chart-wrap{height:420px; padding:12px}
Â  .small{font-size:13px; color:var(--muted)}
Â  .signal-buy{color:var(--green); font-weight:800}
Â  .signal-sell{color:var(--red); font-weight:800}
Â  .inline{display:flex; gap:8px; align-items:center;}
Â  .muted{color:var(--muted)}
Â  .risk-panel { padding: 10px; background: #2c313a; border-radius: 6px; margin-top: 10px; }
Â  .win { color: var(--green); }
Â  .loss { color: var(--red); }
Â  .neutral { color: var(--yellow); }
</style>
</head>
<body>
<div class="wrap card">
Â  <header>
Â  Â  <h1>ğŸ“ˆ Bollinger VIX10 â€” Deriv (V9)</h1>
Â  Â  <div class="small muted">**Filtro EMA de TendÃªncia** Adicionado para Evitar Contra-TendÃªncia.</div>
Â  </header>

Â  <div class="grid">
Â  Â  Â  Â  <div class="card" style="padding:12px;">
Â  Â  Â  <label>Token da Deriv (DEMO)</label>
Â  Â  Â  <input id="api-token" placeholder="Cole seu token demo aqui" autocomplete="off">
Â  Â  Â  
Â  Â  Â  <h4 style="margin-top:12px;">âš™ï¸ ParÃ¢metros do Bollinger</h4>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div style="flex:1;"><label>PerÃ­odo (SMA) â€” N</label><input id="periods" type="number" min="2" value="20"></div>
Â  Â  Â  Â  <div style="flex:1;"><label>Desvio K</label><input id="k" type="number" min="0.1" step="0.1" value="2"></div>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  <h4 style="margin-top:12px;">ğŸ”¬ Filtros (RSI & TendÃªncia)</h4>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div style="flex:1;"><label>PerÃ­odo RSI</label><input id="rsi-periods" type="number" min="2" value="14"></div>
Â  Â  Â  Â  <div style="flex:1;"><label>RSI Sobrevenda</label><input id="rsi-lower" type="number" min="1" max="50" value="30"></div>
Â  Â  Â  Â  <div style="flex:1;"><label>RSI Sobrecompra</label><input id="rsi-upper" type="number" min="50" max="99" value="70"></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div style="flex:1;"><label>PerÃ­odo EMA (TendÃªncia)</label><input id="ema-periods" type="number" min="50" value="100"></div>
Â  Â  Â  Â  <div style="flex:1;"></div>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  <h4 style="margin-top:12px;">ğŸ’¸ ConfiguraÃ§Ã£o do Trade</h4>
Â  Â  Â  <label>Valor de entrada (USD)</label><input id="entry-amount" type="number" min="0.35" step="0.01" value="0.35">
Â  Â  Â  <label>DuraÃ§Ã£o do contrato (segundos)</label><input id="duration" type="number" value="15" min="1">
Â  Â  Â  <label>Tipo de contrato</label>
Â  Â  Â  <select id="contract-type">
Â  Â  Â  Â  <option value="RISE">Rise (CALL)</option>
Â  Â  Â  Â  <option value="FALL">Fall (PUT)</option>
Â  Â  Â  </select>
Â  Â  Â  <label>Modo</label>
Â  Â  Â  <select id="mode"><option value="SIGNAL_ONLY">Somente Sinal</option><option value="AUTO_TRADE">Auto Trade (enviar ordem)</option></select>

Â  Â  Â  Â  Â  Â  <h4 style="margin-top:12px;">ğŸ›¡ï¸ Controle de Risco (USD)</h4>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div style="flex:1;"><label>Limite Perda DiÃ¡ria</label><input id="daily-loss-limit" type="number" min="0" value="10"></div>
Â  Â  Â  Â  <div style="flex:1;"><label>MÃ¡x. Perdas Consecutivas</label><input id="max-consecutive-loss" type="number" min="1" value="3"></div>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="row" style="margin-top:12px;">
Â  Â  Â  Â  <button id="btn-connect" class="btn-green">Conectar & Iniciar</button>
Â  Â  Â  Â  <button id="btn-stop" class="btn-red">Parar</button>
Â  Â  Â  </div>
Â  Â  Â  <button id="btn-clear" class="btn-yellow" style="margin-top:8px;">Limpar HistÃ³rico</button>

Â  Â  Â  <div id="status" class="small">Status: â³ aguardando</div>
Â  Â  Â  <div id="risk-info" class="risk-panel small">
Â  Â  Â  Â  Saldo: <span id="current-balance">--</span> | Perdas Consec.: <span id="consec-losses">0</span> | RSI: <span id="current-rsi">--</span> | **EMA:** <span id="current-ema" class="neutral">--</span>
Â  Â  Â  </div>

Â  Â  Â  <h4 style="margin-top:12px;">Ãšltimo sinal (BB + RSI + EMA)</h4>
Â  Â  Â  <div id="last-signal" style="font-size:16px; font-weight:700;">Nenhum</div>

Â  Â  Â  <h4 style="margin-top:12px;">Logs da API</h4>
Â  Â  Â  <div id="log"></div>

Â  Â  Â  <h4 style="margin-top:12px;">Resultados da SimulaÃ§Ã£o <span id="win-loss-count">W: 0 | L: 0</span></h4>
Â  Â  Â  <div id="result-log"></div>
Â  Â  </div>

Â  Â  Â  Â  <div class="card" id="chart-wrap">
Â  Â  Â  <canvas id="chart"></canvas>
Â  Â  Â  <div class="inline" style="justify-content:space-between;margin-top:10px;">
Â  Â  Â  Â  <div class="small">PreÃ§o atual: <span id="current-price">--</span></div>
Â  Â  Â  Â  <div class="small">BB: <span id="bb-values">--</span></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<script>
/*
Â  Bollinger V9 (Final) â€” ImplementaÃ§Ã£o do Filtro EMA de TendÃªncia
Â  CombinaÃ§Ã£o: Bollinger (ReversÃ£o) + RSI (Momento) + EMA (TendÃªncia)
*/

/* -------------------------
Â  Â Helpers / estado global
Â  Â ------------------------- */
const SYMBOL = 'R_10';
const APP_ID = 1089;
const API_ENDPOINT = 'wss://ws.derivws.com/websockets/v3';

let ws = null;
let isConnected = false;
let priceHistory = [];Â  Â  
let chart = null;
let lastSignal = null;
let pendingBuyRequests = {};
let consecutiveLosses = 0;
let initialBalance = 0;
let currentBalance = 0;
let isTradingAllowed = true;
let totalWins = 0;
let totalLosses = 0;
let lastEMA = null; // Armazena a Ãºltima EMA calculada para o prÃ³ximo cÃ¡lculo

/* UI elements */
const elToken = document.getElementById('api-token');
const elPeriods = document.getElementById('periods');
const elK = document.getElementById('k');
const elRsiPeriods = document.getElementById('rsi-periods');
const elRsiLower = document.getElementById('rsi-lower');
const elRsiUpper = document.getElementById('rsi-upper');
const elEmaPeriods = document.getElementById('ema-periods'); // Novo
const elEntry = document.getElementById('entry-amount');
const elContractType = document.getElementById('contract-type');
const elMode = document.getElementById('mode');
const elDuration = document.getElementById('duration');
const elDailyLossLimit = document.getElementById('daily-loss-limit');
const elMaxConsecutiveLoss = document.getElementById('max-consecutive-loss');

const elStatus = document.getElementById('status');
const elLog = document.getElementById('log');
const elResultLog = document.getElementById('result-log');
const elWinLossCount = document.getElementById('win-loss-count');
const elCurrentPrice = document.getElementById('current-price');
const elBbValues = document.getElementById('bb-values');
const elCurrentRsi = document.getElementById('current-rsi');
const elCurrentEma = document.getElementById('current-ema'); // Novo
const elLastSignal = document.getElementById('last-signal');
const elCurrentBalance = document.getElementById('current-balance');
const elConsecLosses = document.getElementById('consec-losses');

function generateRequestId() {
Â  return Math.random().toString(36).substring(2, 15);
}

function log(msg){
Â  const time = new Date().toLocaleTimeString();
Â  elLog.innerHTML = `<div>[${time}] ${msg}</div>` + elLog.innerHTML;
}
function logResult(msg, type){
Â  const time = new Date().toLocaleTimeString();
Â  elResultLog.innerHTML = `<div class="${type}">[${time}] ${msg}</div>` + elResultLog.innerHTML;
Â  elWinLossCount.textContent = `W: ${totalWins} | L: ${totalLosses}`;
}

function beep(type='short'){
Â  try{
Â  Â  const ctx = new (window.AudioContext || window.webkitAudioContext)();
Â  Â  const o = ctx.createOscillator();
Â  Â  const g = ctx.createGain();
Â  Â  o.type = 'sine';
Â  Â  o.frequency.value = type==='buy'?880:440;
Â  Â  g.gain.value = 0.02;
Â  Â  o.connect(g); g.connect(ctx.destination);
Â  Â  o.start();
Â  Â  setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
Â  }catch(e){ /* audio bloqueado */ }
}

/* -------------------------
Â  Â Indicators
Â  Â ------------------------- */

// 1. Bollinger Bands
function calculateBollinger(prices, N, K){
Â  if(prices.length < N) return null;
Â  const last = prices.slice(-N);
Â  const sum = last.reduce((a,b)=>a+b,0);
Â  const mean = sum / N;
Â  const variance = last.reduce((acc,p)=> acc + Math.pow(p-mean,2), 0) / N;
Â  const sd = Math.sqrt(variance);
Â  return { upper: mean + K*sd, middle: mean, lower: mean - K*sd, sd };
}

// 2. Relative Strength Index (RSI)
function calculateRSI(prices, N) {
Â  if (prices.length < N + 1) return null;
Â  
Â  let avgGain = 0;
Â  let avgLoss = 0;
Â  
Â  for (let i = prices.length - N; i < prices.length; i++) {
Â  Â  const diff = prices[i] - prices[i - 1];
Â  Â  if (diff > 0) {
Â  Â  Â  avgGain += diff;
Â  Â  } else {
Â  Â  Â  avgLoss += Math.abs(diff);
Â  Â  }
Â  }
Â  avgGain /= N;
Â  avgLoss /= N;

Â  if (avgLoss === 0) return 100;
Â  
Â  const rs = avgGain / avgLoss;
Â  return 100 - (100 / (1 + rs));
}

// 3. Exponential Moving Average (EMA) - NOVO FILTRO DE TENDÃŠNCIA
function calculateEMA(price, N) {
Â  // Multiplicador para a EMA: K = 2 / (N + 1)
Â  const K = 2 / (N + 1);
Â  
Â  if (priceHistory.length < N) {
Â  Â  // Ainda nÃ£o hÃ¡ dados suficientes, calcula uma SMA para a primeira EMA
Â  Â  if (priceHistory.length === N - 1) { // Prepara para a primeira EMA
Â  Â  Â  const sum = priceHistory.reduce((a, b) => a + b, 0) + price;
Â  Â  Â  lastEMA = sum / N;
Â  Â  }
Â  Â  return null;
Â  }
Â  
Â  if (lastEMA === null) {
Â  Â  // Caso de inicializaÃ§Ã£o tardia: calcula a SMA de N ticks anteriores
Â  Â  const initialPrices = priceHistory.slice(priceHistory.length - N);
Â  Â  const sum = initialPrices.reduce((a, b) => a + b, 0);
Â  Â  lastEMA = sum / N;
Â  Â  return lastEMA;
Â  }
Â  
Â  // FÃ³rmula da EMA: EMA = [PreÃ§o * K] + [EMA Anterior * (1 - K)]
Â  const currentEMA = (price * K) + (lastEMA * (1 - K));
Â  lastEMA = currentEMA;
Â  
Â  return currentEMA;
}


/* -------------------------
Â  Â Chart
Â  Â ------------------------- */
let labels = [];
function initChart(){
Â  const ctx = document.getElementById('chart').getContext('2d');
Â  chart = new Chart(ctx, {
Â  Â  type:'line',
Â  Â  data:{
Â  Â  Â  labels: labels,
Â  Â  Â  datasets:[
Â  Â  Â  Â  { label:'PreÃ§o', data: priceHistory, borderWidth:1.6, tension:0.2, pointRadius:0, borderColor:'rgba(84,160,255,1)', fill:false },
Â  Â  Â  Â  { label:'BB Superior', data:[], borderWidth:1, pointRadius:0, borderDash:[6,4], borderColor:'rgba(255,120,150,0.9)', fill:false },
Â  Â  Â  Â  { label:'BB MÃ©dio', data:[], borderWidth:1, pointRadius:0, borderColor:'rgba(255,200,90,0.9)', fill:false },
Â  Â  Â  Â  { label:'BB Inferior', data:[], borderWidth:1, pointRadius:0, borderDash:[6,4], borderColor:'rgba(150,230,140,0.9)', fill:false },
Â  Â  Â  Â  { label:'EMA Longa', data:[], borderWidth:1.2, pointRadius:0, borderColor:'rgba(108,195,213,0.8)', fill:false } // Nova linha EMA
Â  Â  Â  ]
Â  Â  },
Â  Â  options:{
Â  Â  Â  animation:false,
Â  Â  Â  plugins:{legend:{display:true}},
Â  Â  Â  scales:{ x:{ display:false }, y:{ beginAtZero:false } }
Â  Â  }
Â  });
}

function updateChart(bb, ema){
Â  const nowLabel = new Date().toLocaleTimeString();
Â  labels.push(nowLabel);
Â  if(labels.length>300) labels.shift();

Â  while(chart.data.datasets[0].data.length < labels.length-1) chart.data.datasets.forEach(ds => ds.data.unshift(null));
Â  chart.data.datasets[0].data.push(priceHistory[priceHistory.length-1]);

Â  const upper = bb ? bb.upper : null;
Â  const midÂ  Â = bb ? bb.middle : null;
Â  const lower = bb ? bb.lower : null;

Â  chart.data.datasets[1].data.push(upper);
Â  chart.data.datasets[2].data.push(mid);
Â  chart.data.datasets[3].data.push(lower);
Â  chart.data.datasets[4].data.push(ema); // Adiciona EMA

Â  chart.data.datasets.forEach(ds => { if(ds.data.length>300) ds.data.shift(); });
Â  if(chart.data.labels.length>300) chart.data.labels.shift();

Â  chart.update('none');
}

/* -------------------------
Â  Â Log de Resultado Simulado
Â  Â ------------------------- */
function startResultSimulation(signal, entryPrice, durationSeconds){
Â  log(`SimulaÃ§Ã£o iniciada para ${signal} em $${entryPrice.toFixed(5)}. Aguardando ${durationSeconds}s...`);

Â  setTimeout(() => {
Â  Â  const closingPrice = priceHistory[priceHistory.length - 1];
Â  Â  if (!closingPrice) {
Â  Â  Â  logResult(`Erro SimulaÃ§Ã£o: PreÃ§o de fechamento nÃ£o disponÃ­vel.`, 'muted');
Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  let resultType = 'LOSS';
Â  Â  let resultMsg = `Sinal ${signal} em $${entryPrice.toFixed(5)} -> Fechamento em $${closingPrice.toFixed(5)}: `;

Â  Â  if (signal === 'BUY') {
Â  Â  Â  if (closingPrice > entryPrice) {
Â  Â  Â  Â  resultType = 'WIN';
Â  Â  Â  Â  totalWins++;
Â  Â  Â  Â  resultMsg += 'WIN (PreÃ§o subiu)';
Â  Â  Â  } else {
Â  Â  Â  Â  resultType = 'LOSS';
Â  Â  Â  Â  totalLosses++;
Â  Â  Â  Â  resultMsg += 'LOSS (PreÃ§o nÃ£o subiu)';
Â  Â  Â  }
Â  Â  } else if (signal === 'SELL') {
Â  Â  Â  if (closingPrice < entryPrice) {
Â  Â  Â  Â  resultType = 'WIN';
Â  Â  Â  Â  totalWins++;
Â  Â  Â  Â  resultMsg += 'WIN (PreÃ§o caiu)';
Â  Â  Â  } else {
Â  Â  Â  Â  resultType = 'LOSS';
Â  Â  Â  Â  totalLosses++;
Â  Â  Â  Â  resultMsg += 'LOSS (PreÃ§o nÃ£o caiu)';
Â  Â  Â  }
Â  Â  }

Â  Â  logResult(resultMsg, resultType.toLowerCase());

Â  }, durationSeconds * 1000);
}


/* -------------------------
Â  Â Trading logic (signals + filtros)
Â  Â ------------------------- */
function checkBollingerSignal(currentPrice, bb){
Â  if(!bb) return null;
Â  if(currentPrice <= bb.lower) return 'BUY';
Â  if(currentPrice >= bb.upper) return 'SELL';
Â  return null;
}

function checkRsiFilter(rsi){
Â  if(!rsi) return null;

Â  const lower = parseInt(elRsiLower.value, 10) || 30;
Â  const upper = parseInt(elRsiUpper.value, 10) || 70;

Â  if (rsi <= lower) return 'RSI_BUY';
Â  if (rsi >= upper) return 'RSI_SELL';
Â  
Â  return 'RSI_NEUTRAL';
}

// NOVO FILTRO DE TENDÃŠNCIA
function checkEmaTrendFilter(currentPrice, ema){
Â  if(!ema) return null;
Â  
Â  if (currentPrice > ema) return 'TREND_UP';
Â  if (currentPrice < ema) return 'TREND_DOWN';
Â  
Â  return 'TREND_NEUTRAL';
}


function buildBuyParameters(signal, currentPrice){
Â  // Simplificado para RISE/FALL na V9, eliminando a barreira.
Â  const contractOption = elContractType.value;
Â  const amount = parseFloat(elEntry.value) || 0.35;
Â  const duration = parseInt(elDuration.value,10) || 15;
Â  
Â  const params = {
Â  Â  amount: amount,
Â  Â  basis: 'stake',
Â  Â  contract_type: (signal === 'BUY') ? 'RISE' : 'FALL',
Â  Â  currency: 'USD',
Â  Â  duration: duration,
Â  Â  duration_unit: 's',
Â  Â  symbol: SYMBOL
Â  };

Â  return params;
}

function sendBuy(params){
Â  return new Promise((resolve, reject) => {
Â  Â  // ... (LÃ³gica de sendBuy idÃªntica Ã  V8) ...
Â  Â  if(!ws || ws.readyState !== WebSocket.OPEN){
Â  Â  Â  reject(new Error('WebSocket nÃ£o conectado'));
Â  Â  Â  return;
Â  Â  }

Â  Â  const reqId = generateRequestId();
Â  Â  const req = { buy: 1, price: params.amount, parameters: params, req_id: reqId };
Â  Â  
Â  Â  pendingBuyRequests[reqId] = { resolve, reject };

Â  Â  log(`Ordem enviada (ID: ${reqId}). Tipo: ${params.contract_type}. Aguardando confirmaÃ§Ã£o...`);
Â  Â  ws.send(JSON.stringify(req));

Â  Â  setTimeout(() => {
Â  Â  Â  if(pendingBuyRequests[reqId]){
Â  Â  Â  Â  pendingBuyRequests[reqId].reject(new Error(`Timeout de confirmaÃ§Ã£o (ID: ${reqId})`));
Â  Â  Â  Â  delete pendingBuyRequests[reqId];
Â  Â  Â  }
Â  Â  }, 10000); 
Â  });
}

/* -------------------------
Â  Â Tick handler (main loop)
Â  Â ------------------------- */
async function handleTick(price){
Â  // Armazena o tick
Â  priceHistory.push(price);
Â  if(priceHistory.length > 600) priceHistory.shift();

Â  elCurrentPrice.textContent = price.toFixed(5);

Â  // Calcular Indicadores
Â  const N_BB = parseInt(elPeriods.value,10) || 20;
Â  const K = parseFloat(elK.value) || 2;
Â  const bb = calculateBollinger(priceHistory, N_BB, K);
Â  
Â  const N_RSI = parseInt(elRsiPeriods.value,10) || 14;
Â  const rsi = calculateRSI(priceHistory, N_RSI);

Â  const N_EMA = parseInt(elEmaPeriods.value,10) || 100; // Novo
Â  const ema = calculateEMA(price, N_EMA); // Novo

Â  // Atualiza UI de Indicadores
Â  if(bb){ elBbValues.textContent = `${bb.upper.toFixed(5)} / ${bb.middle.toFixed(5)} / ${bb.lower.toFixed(5)}`; } else { elBbValues.textContent = 'Aguardando histÃ³rico BB...'; }
Â  if(rsi){ elCurrentRsi.textContent = rsi.toFixed(2); } else { elCurrentRsi.textContent = '--'; }
Â  if(ema){ 
Â  Â  elCurrentEma.textContent = ema.toFixed(5); 
Â  Â  elCurrentEma.className = (price > ema) ? 'signal-buy' : 'signal-sell';
Â  } else { 
Â  Â  elCurrentEma.textContent = '--'; 
Â  Â  elCurrentEma.className = 'neutral';
Â  }


Â  if(chart) updateChart(bb, ema);
Â  else { initChart(); }

Â  // Checagem de Sinal e Filtros
Â  const bbSignal = checkBollingerSignal(price, bb);
Â  const rsiFilter = checkRsiFilter(rsi);
Â  const emaFilter = checkEmaTrendFilter(price, ema); // Novo Filtro
Â  const durationSeconds = parseInt(elDuration.value,10) || 15;
Â  
Â  let finalSignal = null;
Â  let signalType = 'Nenhum';

Â  // COMBINAÃ‡ÃƒO DE SINAL (BB + RSI + EMA)
Â  // Sinais de ReversÃ£o devem ser alinhados Ã  tendÃªncia (EMA)
Â  
Â  // BUY: BB Inferior + RSI Sobrevenda + TendÃªncia de ALTA (PreÃ§o > EMA)
Â  if(bbSignal === 'BUY' && rsiFilter === 'RSI_BUY' && emaFilter === 'TREND_UP'){
Â  Â  finalSignal = 'BUY';
Â  Â  signalType = 'COMPRA (BB + RSI + EMA: ALTA)';
Â  } 
Â  // SELL: BB Superior + RSI Sobrecompra + TendÃªncia de BAIXA (PreÃ§o < EMA)
Â  else if (bbSignal === 'SELL' && rsiFilter === 'RSI_SELL' && emaFilter === 'TREND_DOWN'){
Â  Â  finalSignal = 'SELL';
Â  Â  signalType = 'VENDA (BB + RSI + EMA: BAIXA)';
Â  }


Â  // Disparar AÃ§Ã£o
Â  if(finalSignal){
Â  Â  if(finalSignal !== lastSignal){
Â  Â  Â  lastSignal = finalSignal;
Â  Â  Â  elLastSignal.textContent = signalType + ' @ ' + price.toFixed(5);
Â  Â  Â  elLastSignal.className = (finalSignal==='BUY') ? 'signal-buy' : 'signal-sell';
Â  Â  Â  log('SINAL TRÃPLICE CONFIRMADO: ' + signalType);
Â  Â  Â  beep(finalSignal==='BUY' ? 'buy' : 'sell');

Â  Â  Â  startResultSimulation(finalSignal, price, durationSeconds);

Â  Â  Â  if(elMode.value === 'AUTO_TRADE' && isTradingAllowed){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const params = buildBuyParameters(finalSignal, price);
Â  Â  Â  Â  Â  await sendBuy(params);
Â  Â  Â  Â  }catch(err){
Â  Â  Â  Â  Â  log('âŒ Erro na compra/confirmaÃ§Ã£o: ' + (err.message || err));
Â  Â  Â  Â  Â  consecutiveLosses++;
Â  Â  Â  Â  Â  checkRiskStatus();
Â  Â  Â  Â  }
Â  Â  Â  } else if (elMode.value === 'AUTO_TRADE' && !isTradingAllowed) {
Â  Â  Â  Â  log('Sinal ignorado: Bot estÃ¡ Parado por Regra de Risco.');
Â  Â  Â  }
Â  Â  }
Â  } else {
Â  Â  // Sinal ignorado por falta de confirmaÃ§Ã£o EMA ou RSI
Â  Â  lastSignal = null;
Â  Â  elLastSignal.className = 'muted';
Â  Â  elLastSignal.textContent = 'Nenhum';
Â  }
}


/* -------------------------
Â  Â BotÃ£o Limpar HistÃ³rico
Â  Â ------------------------- */
function clearHistory(){
Â  // ... (LÃ³gica idÃªntica Ã  V8) ...
Â  elLog.innerHTML = '';
Â  elResultLog.innerHTML = '';
Â  totalWins = 0;
Â  totalLosses = 0;
Â  elWinLossCount.textContent = 'W: 0 | L: 0';
Â  
Â  priceHistory = [];
Â  labels = [];
Â  lastEMA = null; // Resetar EMA
Â  if(chart){
Â  Â  chart.data.labels = [];
Â  Â  chart.data.datasets.forEach(dataset => {
Â  Â  Â  dataset.data = [];
Â  Â  });
Â  Â  chart.update('none');
Â  }
Â  log('HistÃ³rico, logs e grÃ¡fico limpos. EMA resetada.');
}

document.getElementById('btn-clear').addEventListener('click', clearHistory);


/* -------------------------
Â  Â Initializers / ConexÃ£o
Â  Â ------------------------- */
// ... (FunÃ§Ãµes checkRiskStatus, handleContractResult, subscribeTicks, subscribeBalance, connectWebSocket, stopConnection idÃªnticas Ã  V8) ...
function checkRiskStatus(){
Â  const dailyLossLimit = parseFloat(elDailyLossLimit.value);
Â  const maxConsecutiveLoss = parseInt(elMaxConsecutiveLoss.value, 10);
Â  const totalLoss = initialBalance - currentBalance;
Â  
Â  isTradingAllowed = true;

Â  if(initialBalance > 0 && totalLoss >= dailyLossLimit){
Â  Â  isTradingAllowed = false;
Â  Â  elStatus.textContent = 'Status: ğŸ›‘ RISCO: Limite de Perda DiÃ¡ria atingido!';
Â  Â  log(`ğŸ›‘ Limite de Perda DiÃ¡ria ($${dailyLossLimit}) atingido! Parando bot.`);
Â  Â  stopConnection();
Â  Â  return;
Â  }

Â  if(consecutiveLosses >= maxConsecutiveLoss){
Â  Â  isTradingAllowed = false;
Â  Â  elStatus.textContent = `Status: ğŸ›‘ RISCO: ${maxConsecutiveLoss} Perdas Consecutivas! Parado.`;
Â  Â  log(`ğŸ›‘ MÃ¡ximo de Perdas Consecutivas (${maxConsecutiveLoss}) atingido! Parando bot.`);
Â  Â  stopConnection();
Â  Â  return;
Â  }

Â  elConsecLosses.textContent = consecutiveLosses;
Â  elConsecLosses.className = (consecutiveLosses > 0) ? 'signal-sell' : 'signal-buy';
}

function handleContractResult(result){
Â  if(result.profit > 0){
Â  Â  log(`âœ… TRADE WIN! Lucro: $${result.profit.toFixed(2)}`);
Â  Â  consecutiveLosses = 0;
Â  } else {
Â  Â  log(`âŒ TRADE LOSS! Perda: $${result.buy_price.toFixed(2)}`);
Â  Â  consecutiveLosses++;
Â  }
}

function subscribeTicks(){
Â  if(!ws || ws.readyState !== WebSocket.OPEN) return;
Â  const req = { ticks: SYMBOL };
Â  ws.send(JSON.stringify(req));
Â  log('SubscriÃ§Ã£o de ticks solicitada.');
}

function subscribeBalance(){
Â  if(!ws || ws.readyState !== WebSocket.OPEN) return;
Â  const req = { balance: 1, subscribe: 1 }; 
Â  ws.send(JSON.stringify(req));
}

function connectWebSocket(token){
Â  return new Promise((resolve, reject) => {
Â  Â  ws = new WebSocket(`${API_ENDPOINT}?app_id=${APP_ID}`);

Â  Â  ws.onopen = () => {
Â  Â  Â  const authReq = { authorize: token };
Â  Â  Â  ws.send(JSON.stringify(authReq));
Â  Â  };

Â  Â  ws.onmessage = (evt) => {
Â  Â  Â  try{
Â  Â  Â  Â  const data = JSON.parse(evt.data);
Â  Â  Â  Â  const reqId = data.req_id;

Â  Â  Â  Â  if(data.authorize){
Â  Â  Â  Â  Â  if(data.error){ reject(new Error(data.error.message || 'Auth error')); return; }
Â  Â  Â  Â  Â  isConnected = true;
Â  Â  Â  Â  Â  resolve(data.authorize); return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if(data.buy && reqId && pendingBuyRequests[reqId]){
Â  Â  Â  Â  Â  if(data.error){ pendingBuyRequests[reqId].reject(data.error.message || 'Erro na compra'); } else { pendingBuyRequests[reqId].resolve(data.buy); }
Â  Â  Â  Â  Â  delete pendingBuyRequests[reqId];
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(data.proposal_open_contract && data.proposal_open_contract.is_sold){ handleContractResult(data.proposal_open_contract); }

Â  Â  Â  Â  if(data.balance && data.balance.balance){
Â  Â  Â  Â  Â  const newBalance = parseFloat(data.balance.balance);
Â  Â  Â  Â  Â  if(initialBalance === 0) initialBalance = newBalance;
Â  Â  Â  Â  Â  currentBalance = newBalance;
Â  Â  Â  Â  Â  elCurrentBalance.textContent = `$${currentBalance.toFixed(2)}`;
Â  Â  Â  Â  Â  checkRiskStatus();
Â  Â  Â  Â  }

Â  Â  Â  Â  if(data.tick && data.tick.quote){ handleTick(parseFloat(data.tick.quote)); }

Â  Â  Â  }catch(e){ console.error('Erro parsing msg', e, evt.data); }
Â  Â  };

Â  Â  ws.onclose = (e) => {
Â  Â  Â  log('WebSocket fechado. Motivo: ' + (e.reason || 'n/a'));
Â  Â  Â  isConnected = false;
Â  Â  Â  elStatus.textContent = 'Status: desconectado';
Â  Â  };

Â  Â  ws.onerror = (err) => {
Â  Â  Â  log('Erro no WebSocket (veja console).');
Â  Â  Â  elStatus.textContent = 'Status: erro no websocket';
Â  Â  Â  reject(err);
Â  Â  };
Â  });
}

document.getElementById('btn-connect').addEventListener('click', async () => {
Â  const token = elToken.value.trim();
Â  if(!token){ alert('Cole seu token demo da Deriv.'); return; }

Â  elStatus.textContent = 'Status: conectando...';
Â  isTradingAllowed = true; 
Â  consecutiveLosses = 0; 
Â  initialBalance = 0; 

Â  try{
Â  Â  await connectWebSocket(token);
Â  Â  log('Autorizado na API Deriv. (ID: ' + (ws.auth?.loginid || '--') + ')');
Â  Â  elStatus.textContent = 'Status: âœ… Conectado â€” solicitando dados.';
Â  Â  
Â  Â  subscribeBalance();
Â  Â  subscribeTicks();

Â  }catch(err){
Â  Â  log('Erro fatal na conexÃ£o/autorizaÃ§Ã£o: ' + (err.message || err));
Â  Â  elStatus.textContent = 'Status: erro fatal';
Â  Â  if(ws) ws.close();
Â  Â  ws = null;
Â  }
});

function stopConnection(){
Â  if(ws){
Â  Â  try{ ws.close(); }catch(e){}
Â  Â  ws = null;
Â  }
Â  elStatus.textContent = 'Status: ğŸ”´ Parado';
}

document.getElementById('btn-stop').addEventListener('click', ()=> {
Â  stopConnection();
Â  log('Parado pelo usuÃ¡rio');
});


/* Initialize empty chart */
initChart();
log('V9 carregada. Filtro EMA (TendÃªncia) implementado.');
</script>
</body>
</html>