<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Indicador Scalping PRO v5 - Otimizado (CALL/PUT Separados)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
Â  --bg:#071225; --panel:#0b1722; --muted:#9fb0c6; --accent:#0ea5a4; --call:#22c55e; --put:#ef4444; --card:#08121a;
Â  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#041021 0%,#061224 100%);color:#d8e8f2}
.container{max-width:1080px;margin:18px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.02)}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.title{font-weight:800;font-size:18px}
.sub{color:var(--muted);font-size:13px;margin-top:4px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#012;border:none;padding:10px 14px;border-radius:9px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.grid{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:14px}
.panel{background:var(--panel);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
.status{padding:10px;border-radius:8px;text-align:center;font-weight:800}
.status.disconnected{background:#3b1313;color:#ffdcdc}
.status.connected{background:#072615;color:#c7f6d2}
.field{margin-bottom:10px}
.label{font-size:13px;color:var(--muted);margin-bottom:6px}
.input,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
.small-muted{font-size:12px;color:var(--muted)}
.signal-box{margin-top:12px;padding:14px;border-radius:10px;text-align:center;font-weight:800;font-size:18px}
.signal-call{background:linear-gradient(90deg, rgba(34,197,94,0.10), rgba(34,197,94,0.03));color:var(--call)}
.signal-put{background:linear-gradient(90deg, rgba(239,68,68,0.10), rgba(239,68,68,0.03));color:var(--put)}
.signal-none{background:linear-gradient(90deg, rgba(255,193,7,0.04), rgba(255,193,7,0.01));color:#ffd27a}
.pulse{animation:pulse 0.7s infinite alternate}
@keyframes pulse{from{transform:scale(1)}to{transform:scale(1.02);box-shadow:0 0 20px rgba(255,255,255,0.02)}}
.data-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
.data-item{background:var(--card);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.chart-wrap{height:360px;padding:8px}
.history{max-height:260px;overflow:auto;margin-top:10px}
.history table{width:100%;border-collapse:collapse}
.history th{position:sticky;top:0;background:rgba(0,0,0,0.12);padding:8px;text-align:left;font-size:12px;color:var(--muted)}
.history td{padding:8px;border-top:1px solid rgba(255,255,255,0.02);font-size:13px}
/* NOVOS ESTILOS PARA RESULTADO */
.history tr.win{ background:rgba(34,197,94,0.15); }
.history tr.loss{ background:rgba(239,68,68,0.15); }

.footer{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:12px}
.small{font-size:12px;color:var(--muted)}
@media (max-width:980px){.grid{grid-template-columns:1fr}.chart-wrap{height:260px}}
</style>
</head>
<body>
<div class="container">
Â  <div class="header">
Â  Â  <div>
Â  Â  Â  <div class="title">Indicador Scalping PRO v5 â€” Otimizado (AO VIVO)</div>
Â  Â  Â  <div class="sub">ConexÃ£o WebSocket Deriv **Reativada**. Clique em "Conectar" para iniciar a recepÃ§Ã£o de ticks.</div>
Â  Â  </div>
Â  Â  <div class="controls">
Â  Â  Â  <button id="connectBtn" class="btn">Conectar</button>
Â  Â  </div>
Â  </div>

Â  <div class="grid">
Â  Â  Â  Â  <div class="panel">
Â  Â  Â  <div id="connStatus" class="status disconnected">DESCONECTADO</div>

Â  Â  Â  <div class="field">
Â  Â  Â  Â  <div class="label">Ativo (Deriv)</div>
Â  Â  Â  Â  <select id="assetSelect" class="input">
Â  Â  Â  Â  Â  <option value="R_10">R_10 (Volatility 10)</option>
Â  Â  Â  Â  Â  <option value="R_25">R_25</option>
Â  Â  Â  Â  Â  <option value="R_50">R_50</option>
Â  Â  Â  Â  Â  <option value="R_100">R_100</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="field">
Â  Â  Â  Â  <div class="label">Ciclo de ticks (T1..TN)</div>
Â  Â  Â  Â  <input id="cycleLen" class="input" type="number" min="3" max="20" value="5" />
Â  Â  Â  </div>

Â  Â  Â  <div class="field">
Â  Â  Â  Â  <div class="label">FAKE LOSS (contagens necessÃ¡rias)</div>
Â  Â  Â  Â  <input id="fakeLoss" class="input" type="number" min="1" max="6" value="1" />
Â  Â  Â  </div>

Â  Â  Â  <div class="field">
Â  Â  Â  Â  <div class="label">Confidence mÃ­nimo (0.0 - 1.0)</div>
Â  Â  Â  Â  <input id="confThreshold" class="input" type="number" min="0" max="1" step="0.01" value="0.87" />
Â  Â  Â  </div>

Â  Â  Â  <div class="field">
Â  Â  Â  Â  <div class="label">Filtros (F+E+E)</div>
Â  Â  Â  Â  <div style="display:flex;flex-direction:column;gap:6px">
Â  Â  Â  Â  Â  <label><input type="checkbox" id="useForce" checked /> ForÃ§a (momentum normalizado)</label>
Â  Â  Â  Â  Â  <label><input type="checkbox" id="useExhaust" checked /> ExaustÃ£o (retraÃ§Ã£o / divergÃªncia)</label>
Â  Â  Â  Â  Â  <label><input type="checkbox" id="useExpand" checked /> ExpansÃ£o (volatilidade crescendo)</label>
Â  Â  Â  Â  Â  <label><input type="checkbox" id="useConfirm" checked /> Requer confirmaÃ§Ã£o no prÃ³ximo ciclo (BÃ´nus Ponderado)</label>
Â  Â  Â  Â  Â  <label><input type="checkbox" id="useEmaFilter" checked /> Usar Filtro EMA 100 (TendÃªncia)</label>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="field">
Â  Â  Â  Â  <div class="label">Pesos Base (ForÃ§a, ExaustÃ£o, ExpansÃ£o) â€” A LÃ³gica usa pesos dinÃ¢micos.</div>
Â  Â  Â  Â  <div style="display:flex;gap:6px">
Â  Â  Â  Â  Â  <input id="wForce" class="input" type="number" step="0.01" min="0" max="1" value="0.33" />
Â  Â  Â  Â  Â  <input id="wEx" class="input" type="number" step="0.01" min="0" max="1" value="0.33" />
Â  Â  Â  Â  Â  <input id="wExp" class="input" type="number" step="0.01" min="0" max="1" value="0.34" />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="small-muted">O sistema usa pesos dinÃ¢micos internos. Mantenha os valores prÃ³ximos a 0.33.</div>
Â  Â  Â  </div>

Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  Â  <button id="saveBtn" class="btn">Salvar ConfiguraÃ§Ãµes</button>
Â  Â  Â  Â  <button id="resetBtn" class="btn ghost">Resetar</button>
Â  Â  Â  Â  
Â  Â  Â  </div>

Â  Â  Â  <div id="signalBox" class="signal-box signal-none">AGUARDANDO SINAL...</div>

Â  Â  Â  <div class="data-grid">
Â  Â  Â  Â  <div class="data-item">
Â  Â  Â  Â  Â  <div class="small-muted">Contador de Ticks</div>
Â  Â  Â  Â  Â  <div id="tickCount" style="font-weight:800;font-size:18px">0</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="data-item">
Â  Â  Â  Â  Â  <div class="small-muted">Ãšltimo T1</div>
Â  Â  Â  Â  Â  <div id="t1Show" style="font-weight:800;font-size:18px">---</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="data-item">
Â  Â  Â  Â  Â  <div class="small-muted">Score Atual</div>
Â  Â  Â  Â  Â  <div id="scoreShow" style="font-weight:800;font-size:18px">0.00</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="data-item">
Â  Â  Â  Â  Â  <div class="small-muted">ConfianÃ§a Min</div>
Â  Â  Â  Â  Â  <div id="confShow" style="font-weight:800;font-size:18px">0.87</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div style="margin-top:10px">
Â  Â  Â  Â  <div class="label">HistÃ³rico de Sinais</div>
Â  Â  Â  Â  <div class="history" id="historyWrap">
Â  Â  Â  Â  Â  <table id="histTable"><thead><tr><th>Hora</th><th>Sinal</th><th>Ativo</th><th>T1</th><th>Score</th><th>Res</th></tr></thead><tbody></tbody></table>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  Â  Â  <button id="csvBtn" class="btn ghost">Exportar CSV</button>
Â  Â  Â  Â  Â  <button id="clearHistBtn" class="btn ghost">Limpar HistÃ³rico</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div style="margin-top:10px" class="small-muted">Timer por tick: <span id="tickTimer">â€”</span></div>
Â  Â  </div>

Â  Â  Â  Â  <div class="panel">
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  <div class="small-muted">GrÃ¡fico de ticks (linha)</div>
Â  Â  Â  Â  <div class="small-muted">Sons e notificaÃ§Ãµes embutidos</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="chart-wrap">
Â  Â  Â  Â  <canvas id="chart"></canvas>
Â  Â  Â  </div>

Â  Â  Â  <div style="display:flex;gap:8px;margin-top:12px">
Â  Â  Â  Â  <button id="simBtn" class="btn">Rodar SimulaÃ§Ã£o RÃ¡pida</button>
Â  Â  Â  Â  <div style="flex:1"></div>
Â  Â  Â  Â  <div class="small-muted">ConexÃµes: <span id="reconn">0</span></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="footer small-muted">Sinais emitidos: <span id="emitCount">0</span></div>
Â  Â  </div>
Â  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script>
/*
Â  Indicador Scalping PRO v5 - CÃ³digo Final Consolidado
Â  - LÃ³gica F+E+E com pesos dinÃ¢micos por tipo de sinal.
Â  - Filtro EMA 100 separado para CALL e PUT.
Â  - Rastreamento e SimulaÃ§Ã£o de Resultado (WIN/LOSS) na coluna RES.
*/

// ===== Settings & UI refs =====
const DEFAULTS = {
Â  app_id: 1089, // ID da sua aplicaÃ§Ã£o Deriv
Â  asset: 'R_10',
Â  cycleLen: 5,Â 
Â  fakeLoss: 1,Â 
Â  confThreshold: 0.87, // Valor de ConfianÃ§a MÃ­nima ajustado para 0.87
Â  weights: { force:0.33, exhaust:0.33, expand:0.34 },Â 
Â  emaFilterPeriod: 100,
Â  useEmaFilter: true
};

let settings = Object.assign({}, DEFAULTS);

// ReferÃªncias de UI (simplificado para o cÃ³digo final)
const connectBtn = document.getElementById('connectBtn');
const connStatus = document.getElementById('connStatus');
const assetSelect = document.getElementById('assetSelect');
const cycleLenInput = document.getElementById('cycleLen');
const fakeLossInput = document.getElementById('fakeLoss');
const confThresholdInput = document.getElementById('confThreshold');
const useConfirm = document.getElementById('useConfirm');
const useEmaFilter = document.getElementById('useEmaFilter');
const wForce = document.getElementById('wForce');
const wEx = document.getElementById('wEx');
const wExp = document.getElementById('wExp');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const signalBox = document.getElementById('signalBox');
const tickCountEl = document.getElementById('tickCount');
const t1Show = document.getElementById('t1Show');
const scoreShow = document.getElementById('scoreShow');
const confShow = document.getElementById('confShow');
const histTableBody = document.querySelector('#histTable tbody');
const csvBtn = document.getElementById('csvBtn');
const clearHistBtn = document.getElementById('clearHistBtn');
const tickTimer = document.getElementById('tickTimer');
const simBtn = document.getElementById('simBtn');
const reconnEl = document.getElementById('reconn');
const emitCountEl = document.getElementById('emitCount');

let ws = null;
let reconnectAttempts = 0;
let reconnectCount = 0;

// Data buffers and counters
let tickPrices = [];
let tickCount = 0;
let fallCount = 0;
let riseCount = 0;
let emitCount = 0;
let history = [];
let lastTickAt = null;
let pendingConfirm = null;Â 
let activeTrade = null; // NOVO: Para rastrear o trade em andamento

// Sounds
const soundCall = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
const soundPutÂ  = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

// Utils: EMA, stddev, slope, clamp
function ema(values, len){
Â  if(values.length===0) return null;
Â  const k = 2/(len+1);
Â  let e = values[0];
Â  for(let i=1;i<values.length;i++) e = values[i]*k + e*(1-k);
Â  return e;
}
function stddev(values){
Â  if(values.length===0) return 0;
Â  const mean = values.reduce((a,b)=>a+b,0)/values.length;
Â  const variance = values.reduce((a,b)=>a+(b-mean)*(b-mean),0)/values.length;
Â  return Math.sqrt(variance);
}
function slope(values){
Â  if(values.length<2) return 0;
Â  const n = values.length;
Â  const xbar = (n-1)/2;
Â  const ybar = values.reduce((a,b)=>a+b,0)/n;
Â  let num=0, den=0;
Â  for(let i=0;i<n;i++){ num += (i-xbar)*(values[i]-ybar); den += (i-xbar)*(i-xbar); }
Â  return den===0?0:num/den;
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

// Chart setup
const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
Â  type: 'line',
Â  data: { labels: [], datasets: [{ label:'PreÃ§o', data: [], borderWidth:1, tension:0.25, pointRadius:0 }] },
Â  options: { animation:false, responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{beginAtZero:false}} }
});
function pushChart(p){
Â  chart.data.labels.push('');
Â  chart.data.datasets[0].data.push(p);
Â  if(chart.data.labels.length>240){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
Â  chart.update('none');
}

// Save/load/reset settings (permanece igual)
function loadSettings(){
Â  try{
Â  Â  const s = JSON.parse(localStorage.getItem('scalper_v4_settings_improved'));
Â  Â  if(s) settings = Object.assign(settings, s);
Â  }catch(e){}
Â  assetSelect.value = settings.asset || DEFAULTS.asset;
Â  cycleLenInput.value = settings.cycleLen;
Â  fakeLossInput.value = settings.fakeLoss;
Â  confThresholdInput.value = settings.confThreshold;
Â  wForce.value = settings.weights.force;
Â  wEx.value = settings.weights.exhaust;
Â  wExp.value = settings.weights.expand;
Â  useEmaFilter.checked = settings.useEmaFilter !== undefined ? settings.useEmaFilter : DEFAULTS.useEmaFilter;
Â  confShow.textContent = Number(confThresholdInput.value).toFixed(2);
}
function saveSettings(){
Â  settings.asset = assetSelect.value;
Â  settings.cycleLen = Number(cycleLenInput.value);
Â  settings.fakeLoss = Number(fakeLossInput.value);
Â  settings.confThreshold = Number(confThresholdInput.value);
Â  settings.weights = { force: Number(wForce.value), exhaust: Number(wEx.value), expand: Number(wExp.value) };
Â  settings.useEmaFilter = useEmaFilter.checked;
Â  localStorage.setItem('scalper_v4_settings_improved', JSON.stringify(settings));
Â  alert('ConfiguraÃ§Ãµes salvas.');
}
saveBtn.addEventListener('click', saveSettings);
loadSettings();

// History functions (MODIFICADO para incluir a classe WIN/LOSS)
function renderHistory(){ 
    histTableBody.innerHTML = ''; 
    for(const h of history){ 
        const tr = document.createElement('tr'); 
        
        // Adiciona classe para cor de fundo se o resultado for conhecido
        if(h.result) tr.classList.add(h.result.toLowerCase().startsWith('win') ? 'win' : 'loss'); 
        
        tr.innerHTML = `<td>${new Date(h.ts).toLocaleTimeString()}</td><td>${h.signal}</td><td>${h.asset}</td><td>${Number(h.t1).toFixed(4)}</td><td>${h.score.toFixed(2)}</td><td>${h.result||''}</td>`; 
        histTableBody.appendChild(tr); 
    } 
}
function addHistory(sig){ history.unshift(sig); if(history.length>1000) history.pop(); renderHistory(); localStorage.setItem('scalper_v4_history_improved', JSON.stringify(history.slice(0,500))); }
function loadHistory(){ try{ const h = JSON.parse(localStorage.getItem('scalper_v4_history_improved')); if(h) history = h; }catch(e){} renderHistory(); }
loadHistory();

csvBtn.addEventListener('click', ()=>{
Â  if(history.length===0){ alert('Sem histÃ³rico'); return; }
Â  const rows = [['time','signal','asset','t1','score','result']];
Â  for(const r of history) rows.push([new Date(r.ts).toISOString(), r.signal, r.asset, r.t1, r.score, r.result||'']);
Â  const csv = rows.map(r => r.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(',')).join('\n');
Â  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
Â  const a = document.createElement('a'); a.href = url; a.download = 'scalper_v4_history_improved.csv'; a.click(); URL.revokeObjectURL(url);
});
clearHistBtn.addEventListener('click', ()=>{ history=[]; renderHistory(); localStorage.removeItem('scalper_v4_history_improved'); });


function notify(title, body){
Â  if(!('Notification' in window)) return;
Â  if(Notification.permission==='granted') new Notification(title, { body });
Â  else if(Notification.permission!=='denied') Notification.requestPermission().then(p => { if(p==='granted') new Notification(title, { body }); });
}

// Emit signal visuals & history (MODIFICADO para iniciar o rastreamento)
function emitSignal(type, t1, score){
Â  emitCount++;
Â  emitCountEl.textContent = emitCount;

Â  // Adicionar ao histÃ³rico e obter o Ã­ndice (index 0, jÃ¡ que unshift Ã© usado)
Â  const newEntry = { ts: Date.now(), signal: type, asset: settings.asset, t1, score, result: null };
Â  history.unshift(newEntry); 
Â  if(history.length>1000) history.pop(); 
Â  renderHistory(); 
Â  localStorage.setItem('scalper_v4_history_improved', JSON.stringify(history.slice(0,500)));

Â  // NOVO: Rastrear o trade ativo (assume que o trade Ã© para o ciclo atual)
Â  activeTrade = {
Â  Â  index: 0, 
Â  Â  t1: t1,
Â  Â  signal: type
Â  };

Â  if(type === 'CALL'){ signalBox.className = 'signal-box signal-call pulse'; signalBox.textContent = 'ðŸŸ¢ SINAL: CALL NOW!'; try{ soundCall.play(); }catch(e){} }
Â  else { signalBox.className = 'signal-box signal-put pulse'; signalBox.textContent = 'ðŸš¨ SINAL: PUT NOW!'; try{ soundPut.play(); }catch(e){} }
Â  notify('Sinal ' + type, `${settings.asset} â€” ${Number(t1).toFixed(4)} (score ${score.toFixed(2)})`);
Â  setTimeout(() => { signalBox.classList.remove('pulse'); }, 3200);
Â  setTimeout(() => { signalBox.className = 'signal-box signal-none'; signalBox.textContent = 'AGUARDANDO SINAL...'; }, 3600);
}

// Compose F+E+E score (NOVO: LÃ³gica de pesos dinÃ¢micos por tipo de sinal)
function computeScore(rawAction, slice, price, currentEMA, candidate){
Â  // 1) ForÃ§a (momentum)
Â  const Kf = Math.min(Math.floor(slice.length * 0.8), 6);
Â  const sl = slope(slice.slice(-Kf));
Â  const mean = slice.reduce((a,b)=>a+b,0)/slice.length || 1;
Â  let force = clamp((sl / mean) * 1000 + 0.5, 0, 1);
Â  if(rawAction === 'Fall') force = 1 - force; 

Â  // 2) ExaustÃ£o (reversal strength)
Â  let exhaust = 0.5;
Â  if(slice.length >= 4){
Â  Â  const movePrev = slice[slice.length-2] - slice[0];
Â  Â  const retrace = slice[slice.length-1] - slice[slice.length-2];
Â  Â  const rel = Math.abs(retrace) / (Math.abs(movePrev) + 1e-9);
Â  Â  exhaust = clamp(rel * 2, 0, 1);
Â  Â  if(rawAction === 'Rise' && retrace < 0) exhaust = clamp(exhaust + 0.2, 0, 1);
Â  Â  if(rawAction === 'Fall' && retrace > 0) exhaust = clamp(exhaust + 0.2, 0, 1);
Â  }

Â  // 3) ExpansÃ£o (volatility rising)
Â  let expand = 0.5;
Â  if(slice.length >= 6){
Â  Â  const mid = Math.floor(slice.length/2);
Â  Â  const lastWindow = slice.slice(-mid);
Â  Â  const prevWindow = slice.slice(0, mid);
Â  Â  const sdLast = stddev(lastWindow);
Â  Â  const sdPrev = stddev(prevWindow) || 1e-9;
Â  Â  const relVol = (sdLast - sdPrev) / sdPrev;
Â  Â  expand = clamp((relVol + 0.5), 0, 1);
Â  }

Â  // --- LÃ“GICA DE PONTUAÃ‡ÃƒO SEPARADA (PESOS DINÃ‚MICOS) ---
Â  let total;
Â  let customWeights = {};
Â  const type = (rawAction === 'Fall') ? 'PUT' : 'CALL';

Â  if (type === 'PUT') {
Â  Â  // PUT: ReversÃ£o de Alta (Prioriza ExaustÃ£o e ForÃ§a de Queda)
Â  Â  customWeights.wf = 0.30; customWeights.we = 0.50; customWeights.wx = 0.20;
Â  Â  total = customWeights.wf*force + customWeights.we*exhaust + customWeights.wx*expand;

Â  } else { // type === 'CALL'
Â  Â  if(currentEMA !== null && price > currentEMA){
Â  Â  Â  // TendÃªncia de Alta: CALL de ContinuaÃ§Ã£o/Pullback (Prioriza ForÃ§a)
Â  Â  Â  customWeights.wf = 0.45; customWeights.we = 0.30; customWeights.wx = 0.25;
Â  Â  Â  total = customWeights.wf*force + customWeights.we*exhaust + customWeights.wx*expand;
Â  Â  Â  total = clamp(total * 1.05, 0, 1); // BÃ”NUS DE TENDÃŠNCIA

Â  Â  } else {
Â  Â  Â  // TendÃªncia de Baixa: CALL de ReversÃ£o FORTE (Prioriza ExaustÃ£o mÃ¡xima)
Â  Â  Â  customWeights.wf = 0.20; customWeights.we = 0.60; customWeights.wx = 0.20;
Â  Â  Â  total = customWeights.wf*force + customWeights.we*exhaust + customWeights.wx*expand;
Â  Â  }
Â  }
Â  // --- FIM DA LÃ“GICA DE PONTUAÃ‡ÃƒO SEPARADA ---

Â  // ConfirmaÃ§Ã£o bÃ´nus (permanece igual)
Â  if(useConfirm.checked && candidate){
Â  Â  if(candidate.action === rawAction){
Â  Â  Â  total = clamp(total + (candidate.score * 0.15), 0, 1);
Â  Â  } else {
Â  Â  Â  total = clamp(total * 0.9, 0, 1);
Â  Â  }
Â  }

Â  return { total, breakdown: {force, exhaust, expand}, weights: customWeights };
}

// Core tick handler (MODIFICADO com lÃ³gica de filtro e resoluÃ§Ã£o de trade)
function handleTick(tick){
Â  let price = null;
Â  if(tick && typeof tick.quote !== 'undefined') price = parseFloat(tick.quote);
Â  else if(tick && typeof tick === 'number') price = tick;
Â  if(price === null || Number.isNaN(price)) return;

Â  lastTickAt = Date.now();
Â  tickTimer.textContent = 'agora';

Â  tickPrices.push(price);
Â  if(tickPrices.length > 1000) tickPrices.shift();
Â  pushChart(price);

Â  tickCount++;
Â  tickCountEl.textContent = tickCount;

Â  const C = Number(cycleLenInput.value) || settings.cycleLen;
Â  if(tickCount >= C){
Â  Â  const slice = tickPrices.slice(-C);
Â  Â  const t1 = slice[0];
Â  Â  const t6 = slice[Math.max(0, C-2)];
Â  Â  t1Show.textContent = Number(t1).toFixed(4);

Â  Â  // AÃ§Ã£o de ReversÃ£o
Â  Â  const rawAction = (t6 > t1) ? 'Fall' : 'Rise';Â 
Â  Â  if(rawAction === 'Fall'){ fallCount++; riseCount = 0; } else { riseCount++; fallCount = 0; }

Â  Â  // Calcula EMA antes do score
Â  Â  const currentEMA = useEmaFilter.checked ? ema(tickPrices, settings.emaFilterPeriod) : null;

Â  Â  // Compute scores
Â  Â  const scoreObj = computeScore(rawAction, slice, price, currentEMA, pendingConfirm);
Â  Â  scoreShow.textContent = scoreObj.total.toFixed(2);
Â  Â  confShow.textContent = Number(confThresholdInput.value).toFixed(2);

Â  Â  // Determine emission conditions
Â  Â  const needed = Number(fakeLossInput.value) || settings.fakeLoss;
Â  Â  let willEmit = false;
Â  Â  let actionCount = (rawAction === 'Fall') ? fallCount : riseCount;
Â  Â  const type = (rawAction === 'Fall') ? 'PUT' : 'CALL';


Â  Â  // 1. Check needed counts and threshold
Â  Â  if(actionCount >= needed){
Â  Â  Â  // LÃ³gica de ConfirmaÃ§Ã£o (useConfirm) permanece igual
Â  Â  Â  if(useConfirm.checked){
Â  Â  Â  Â  if(!pendingConfirm){Â 
Â  Â  Â  Â  Â  pendingConfirm = {action: rawAction, t1, score: scoreObj.total};Â 
Â  Â  Â  Â  Â  willEmit = false;Â 
Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  if(pendingConfirm.action === rawAction && scoreObj.total >= Number(confThresholdInput.value)) willEmit = true;Â 
Â  Â  Â  Â  Â  pendingConfirm = null;Â 
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  if(scoreObj.total >= Number(confThresholdInput.value)) willEmit = true;
Â  Â  Â  }
Â  Â  }


Â  Â  // 2. NOVO FILTRO ZERO (EMA 100) - LÃ“GICA SEPARADA
Â  Â  if(willEmit && currentEMA !== null){
Â  Â  Â  const diff = price - currentEMA;
Â  Â  Â  
Â  Â  Â  if(type === 'CALL'){
Â  Â  Â  Â  // CALL: BLOQUEIA se estiver em tendÃªncia de baixa suave.
Â  Â  Â  Â  // Permite CALL apenas se estiver acima da EMA OU em reversÃ£o MUITO extrema (abaixo de -0.0005)
Â  Â  Â  Â  if(diff < 0 && diff > -0.0005){ 
Â  Â  Â  Â  Â  willEmit = false;
Â  Â  Â  Â  }
Â  Â  Â  } else if(type === 'PUT'){
Â  Â  Â  Â  // PUT: BLOQUEIA se o preÃ§o estiver acima da EMA (forte tendÃªncia de alta)
Â  Â  Â  Â  if(diff > 0) willEmit = false;
Â  Â  Â  }

Â  Â  }
    
    // --- NOVO: LÃ“GICA DE RESOLUÃ‡ÃƒO DO TRADE ---
Â  Â  if (activeTrade) {
Â  Â  Â  // O trade Ã© resolvido no final do ciclo de C ticks.
      // O preÃ§o de fechamento Ã© o Ãºltimo preÃ§o do ciclo atual (T_end)

Â  Â  Â  const t_end = price; 
Â  Â  Â  const t_start = activeTrade.t1;
Â  Â  Â  let result = 'N/A';
Â  Â  Â  let win = false;

Â  Â  Â  if (activeTrade.signal === 'CALL') {
Â  Â  Â  Â  win = (t_end > t_start);
Â  Â  Â  } else if (activeTrade.signal === 'PUT') {
Â  Â  Â  Â  win = (t_end < t_start);
Â  Â  Â  }
      
Â  Â  Â  // SimulaÃ§Ã£o: se igual, Ã© LOSS (a menos que a opÃ§Ã£o "Equals" esteja ativada na Deriv)
Â  Â  Â  result = win ? 'WIN' : 'LOSS';
Â  Â  Â  if (t_end === t_start) result = 'LOSS (Tie)';


Â  Â  Â  // Atualiza o histÃ³rico
Â  Â  Â  if (history[activeTrade.index]) {
Â  Â  Â  Â  history[activeTrade.index].result = result;
Â  Â  Â  }

Â  Â  Â  activeTrade = null; // Zera o rastreador
Â  Â  Â  renderHistory(); // Re-renderiza a tabela
Â  Â  }
Â  Â  // --- FIM DA LÃ“GICA DE RESOLUÃ‡ÃƒO DO TRADE ---


Â  Â  if(willEmit){
Â  Â  Â  emitSignal(type, t1, scoreObj.total);
Â  Â  Â  fallCount = 0; riseCount = 0;
Â  Â  Â  pendingConfirm = null;
Â  Â  } else if (!willEmit && useConfirm.checked && pendingConfirm && pendingConfirm.action !== rawAction) {
Â  Â  Â  pendingConfirm = null;
Â  Â  }

Â  Â  tickCount = 0;
Â  }
}

// WebSocket (Deriv) - permanece igual
const DERIV_WS = () => `wss://ws.binaryws.com/websockets/v3?app_id=${settings.app_id}`;
let lastHeartbeat = Date.now();

function connectWS(){
Â  if(ws) try{ ws.close(); } catch(e){}
Â  ws = new WebSocket(DERIV_WS());
Â  connStatus.textContent = 'CONECTANDO...'; connStatus.className = 'status disconnected';

Â  ws.onopen = () => {
Â  Â  reconnectAttempts = 0;
Â  Â  reconnectCount++;
Â  Â  reconnEl.textContent = reconnectCount;
Â  Â  connStatus.textContent = 'CONECTADO â€” ' + assetSelect.value;
Â  Â  connStatus.className = 'status connected';
Â  Â  ws.send(JSON.stringify({ ticks: assetSelect.value, subscribe: 1 }));
Â  Â  lastHeartbeat = Date.now();
Â  Â  connectBtn.textContent = 'Desconectar';
Â  };

Â  ws.onmessage = (ev) => {
Â  Â  lastHeartbeat = Date.now();
Â  Â  try{
Â  Â  Â  const msg = JSON.parse(ev.data);
Â  Â  Â  if(msg.msg_type === 'tick' && msg.tick){
Â  Â  Â  Â  handleTick(msg.tick);
Â  Â  Â  } else if(msg.tick){
Â  Â  Â  Â  handleTick(msg.tick);
Â  Â  Â  } else if(msg.error){
Â  Â  Â  Â  console.warn('Deriv error', msg.error);
Â  Â  Â  }
Â  Â  }catch(e){
Â  Â  Â  console.warn('parse error', e);
Â  Â  }
Â  };

Â  ws.onerror = (e) => { console.warn('ws error', e); try{ ws.close(); }catch(e){} };
Â  ws.onclose = () => {
Â  Â  connStatus.textContent = 'DESCONECTADO';
Â  Â  connStatus.className = 'status disconnected';
Â  Â  connectBtn.textContent = 'Conectar';
Â  Â  const timeout = Math.min(30000, 1000 * (2 ** reconnectAttempts));
Â  Â  reconnectAttempts++;
Â  Â  setTimeout(connectWS, timeout);
Â  };

Â  (function heartbeatCheck(){
Â  Â  try{
Â  Â  Â  if(ws.readyState === WebSocket.OPEN && Date.now() - lastHeartbeat > 15000){
Â  Â  Â  Â  console.warn('No heartbeat. Closing connection.');
Â  Â  Â  Â  try{ ws.close(); } catch(e){}
Â  Â  Â  }
Â  Â  }catch(e){}
Â  Â  setTimeout(heartbeatCheck, 5000);
Â  })();
}

// UI Bindings (permanecem iguais)
connectBtn.addEventListener('click', ()=>{
Â  if(ws && ws.readyState === WebSocket.OPEN){
Â  Â  ws.close(); connectBtn.textContent = 'Conectar'; connStatus.textContent = 'DESCONECTADO'; connStatus.className = 'status disconnected';
Â  } else {
Â  Â  connectWS(); connectBtn.textContent = 'Desconectar';
Â  }
});
assetSelect.addEventListener('change', ()=>{Â 
Â  settings.asset = assetSelect.value;Â 
Â  if(ws && ws.readyState === WebSocket.OPEN){Â 
Â  Â  ws.send(JSON.stringify({ forget: 'ticks' }));Â 
Â  Â  ws.send(JSON.stringify({ ticks: assetSelect.value, subscribe:1 }));Â 
Â  Â  connStatus.textContent = 'CONECTADO â€” ' + assetSelect.value;
Â  }Â 
});

resetBtn.addEventListener('click', ()=>{Â 
Â  tickPrices=[]; tickCount=0; fallCount=0; riseCount=0; pendingConfirm=null; activeTrade=null; 
Â  tickCountEl.textContent='0'; t1Show.textContent='---'; scoreShow.textContent='0.00';Â 
Â  emitCount=0; emitCountEl.textContent='0';Â 
Â  chart.data.labels=[]; chart.data.datasets[0].data=[]; chart.update('none');Â 
});

simBtn.addEventListener('click', ()=>{
Â  resetBtn.click();
Â  const N = 300; 
Â  let currentPrice = 100;
Â  let direction = 1;
Â  for(let i=0;i<N;i++){
Â  Â  currentPrice += (Math.random()-0.5) * 0.05 + (direction * 0.01);Â 
Â  Â  if(i % 150 === 0) direction = -direction;Â 
Â  Â  handleTick(currentPrice); 
Â  }
Â  alert('SimulaÃ§Ã£o rÃ¡pida de ' + N + ' ticks concluÃ­da. Sinais potenciais: ' + emitCount);
});


setInterval(()=>{
Â  if(lastTickAt){Â 
Â  Â  const s = Math.round((Date.now()-lastTickAt)/1000);Â 
Â  Â  tickTimer.textContent = s + 's';Â 
Â  Â  if(ws && ws.readyState === WebSocket.OPEN && s > 30){
Â  Â  Â  console.warn('Tick timer expirado. Fechando WS.');
Â  Â  Â  try{ ws.close(); } catch(e){}
Â  Â  }
Â  } else {
Â  Â  tickTimer.textContent = '---';
Â  }
}, 1000);

if('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied'){
Â  Notification.requestPermission();
}

loadSettings();
</script>
</body>
</html>